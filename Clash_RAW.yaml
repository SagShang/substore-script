# Created by SagShang
# Clash routing config for Sub-Store: defines proxy groups, rule providers, and final routing rules.

geodata-mode: true
geo-auto-update: true
geo-update-interval: 24
geox-url:
  geoip: 'https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/release/geoip.dat'
  geosite: 'https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/release/geosite.dat'
  mmdb: 'https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/release/country.mmdb'
  asn: 'https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/release/GeoLite2-ASN.mmdb'

unified-delay: true
tcp-concurrent: true

profile:
  store-selected: true
  store-fake-ip: true

sniffer:
  enable: true
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]
  skip-domain:
    - '+.lan'
    - '+.local'
    - 'Mijia Cloud'
    - '+.push.apple.com'
    - '+.msftconnecttest.com'
    - '+.msftncsi.com'

dns:
  enable: true
  listen: 127.0.0.1:1053
  ipv6: false
  respect-rules: true
  prefer-h3: false
  use-hosts: true
  use-system-hosts: false
  cache-algorithm: arc
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16
  fake-ip-filter-mode: blacklist
  fake-ip-filter:
    - '+.lan'
    - '+.local'
    - 'time.*.com'
    - 'ntp.*.com'
    - '+.ntp.org'
    - '+.market.xiaomi.com'
    - 'geosite:connectivity-check'
    - 'geosite:private'
  default-nameserver:
    - 223.5.5.5
    - 119.29.29.29
  proxy-server-nameserver:
    - 223.5.5.5
    - 119.29.29.29
  nameserver:
    - https://dns.alidns.com/dns-query
    - https://doh.pub/dns-query
  nameserver-policy:
    'geosite:private':
      - 223.5.5.5
      - 119.29.29.29
    'geosite:cn':
      - https://dns.alidns.com/dns-query
      - https://doh.pub/dns-query
    'geosite:gfw':
      - https://dns.cloudflare.com/dns-query#RULES
      - https://dns.google/dns-query#RULES
  fallback:
    - https://dns.cloudflare.com/dns-query#RULES
    - https://dns.google/dns-query#RULES
  fallback-filter:
    geoip: true
    geoip-code: CN
    ipcidr:
      - 240.0.0.0/4

x-templates:
  # proxy groups templates
  group_select_base: &tpl_group_select_base {type: 'select'}
  group_probe_base: &tpl_group_probe_base {url: 'https://cp.cloudflare.com/generate_204', interval: 300, timeout: 3000}
  group_urltest_base: &tpl_group_urltest_base {<<: *tpl_group_probe_base, type: 'url-test', tolerance: 100}
  group_fallback_base: &tpl_group_fallback_base {<<: *tpl_group_probe_base, type: 'fallback'}

  # region filter templates
  filter_region_hk: &tpl_filter_region_hk '(?i)(香港|港|Hong[\s_-]?Kong|\bHK\b|🇭🇰)'
  filter_region_tw: &tpl_filter_region_tw '(?i)(台湾|台|Taiwan|Taipei|Kaohsiung|\bTW\b|\bTWN\b|🇹🇼)'
  filter_region_jp: &tpl_filter_region_jp '(?i)(日本|日|Japan|Tokyo|Osaka|\bJP\b|\bJPN\b|🇯🇵)'
  filter_region_sg: &tpl_filter_region_sg '(?i)(新加坡|狮城|Singapore|\bSG\b|\bSGP\b|🇸🇬)'
  filter_region_us: &tpl_filter_region_us '(?i)(美国|美|United[\s_-]?States|America|\bUS\b|\bUSA\b|Los[\s_-]?Angeles|San[\s_-]?Jose|Santa[\s_-]?Clara|Seattle|Chicago|Dallas|Phoenix|Portland|Oregon|Fremont|Las[\s_-]?Vegas|Silicon[\s_-]?Valley|🇺🇸|🇺🇲)'

  # proxy groups list templates
  group_select_manual: &tpl_group_select_manual {<<: *tpl_group_select_base, proxies: ['♻️ 自动切换', '🔯 故障转移', '🇭🇰 香港节点', '🇹🇼 台湾节点', '🇯🇵 日本节点', '🇸🇬 狮城节点', '🇺🇲 美国节点', '🌍 全球自选', 'DIRECT']}
  group_urltest_auto: &tpl_group_urltest_auto {<<: *tpl_group_urltest_base, proxies: ['🇭🇰 香港节点', '🇹🇼 台湾节点', '🇯🇵 日本节点', '🇸🇬 狮城节点', '🇺🇲 美国节点', '🌍 全球自选']}
  group_fallback_failover: &tpl_group_fallback_failover {<<: *tpl_group_fallback_base, proxies: ['🇭🇰 香港节点', '🇹🇼 台湾节点', '🇯🇵 日本节点', '🇸🇬 狮城节点', '🇺🇲 美国节点', '🌍 全球自选']}
  group_select_full: &tpl_group_select_full {<<: *tpl_group_select_base, proxies: ['🚀 手动选择', '♻️ 自动切换', '🔯 故障转移', '🇭🇰 香港节点', '🇹🇼 台湾节点', '🇯🇵 日本节点', '🇸🇬 狮城节点', '🇺🇲 美国节点', '🌍 全球自选', 'DIRECT', 'REJECT']}
  group_select_direct_first: &tpl_group_select_direct_first {<<: *tpl_group_select_base, proxies: ['DIRECT', '🚀 手动选择', '♻️ 自动切换', '🔯 故障转移', '🇭🇰 香港节点', '🇹🇼 台湾节点', '🇯🇵 日本节点', '🇸🇬 狮城节点', '🇺🇲 美国节点', '🌍 全球自选', 'REJECT']}
  group_select_reject_first: &tpl_group_select_reject_first {<<: *tpl_group_select_base, proxies: ['REJECT', '🚀 手动选择', '♻️ 自动切换', '🔯 故障转移', '🇭🇰 香港节点', '🇹🇼 台湾节点', '🇯🇵 日本节点', '🇸🇬 狮城节点', '🇺🇲 美国节点', '🌍 全球自选', 'DIRECT']}
  group_urltest_region: &tpl_group_urltest_region {<<: *tpl_group_urltest_base, include-all: true}
  group_select_include_all: &tpl_group_select_include_all {<<: *tpl_group_select_base, include-all: true}

  # rule providers templates
  provider_http_base: &tpl_provider_http_base {type: 'http', interval: 86400, behavior: 'classical'}
  provider_http_yaml: &tpl_provider_http_yaml {<<: *tpl_provider_http_base, format: 'yaml'}
  provider_http_text: &tpl_provider_http_text {<<: *tpl_provider_http_base, format: 'text'}

proxy-groups:
  # core groups
  - {name: '🚀 手动选择', <<: *tpl_group_select_manual}
  - {name: '♻️ 自动切换', <<: *tpl_group_urltest_auto}
  - {name: '🔯 故障转移', <<: *tpl_group_fallback_failover}

  # region groups
  - {name: '🇭🇰 香港节点', <<: *tpl_group_urltest_region, filter: *tpl_filter_region_hk}
  - {name: '🇹🇼 台湾节点', <<: *tpl_group_urltest_region, filter: *tpl_filter_region_tw}
  - {name: '🇯🇵 日本节点', <<: *tpl_group_urltest_region, filter: *tpl_filter_region_jp}
  - {name: '🇸🇬 狮城节点', <<: *tpl_group_urltest_region, filter: *tpl_filter_region_sg}
  - {name: '🇺🇲 美国节点', <<: *tpl_group_urltest_region, filter: *tpl_filter_region_us}
  - {name: '🌍 全球自选', <<: *tpl_group_select_include_all}

  # service groups
  - {name: '🌐 谷歌服务', <<: *tpl_group_select_full}
  - {name: '🍎 苹果服务', <<: *tpl_group_select_full}
  - {name: 'Ⓜ️ 微软服务', <<: *tpl_group_select_full}
  - {name: '🤖 人工智能', <<: *tpl_group_select_full}
  - {name: '🎮 游戏平台', <<: *tpl_group_select_full}
  - {name: '📲 电报消息', <<: *tpl_group_select_full}
  - {name: '🐦 推特社交', <<: *tpl_group_select_full}
  - {name: '📘 脸书社交', <<: *tpl_group_select_full}
  - {name: '📹 油管视频', <<: *tpl_group_select_full}
  - {name: '🎬 奈飞影视', <<: *tpl_group_select_full}
  - {name: '🏰 迪士影视', <<: *tpl_group_select_full}
  - {name: '🎧 声田音乐', <<: *tpl_group_select_full}
  - {name: '🎵 抖音国际', <<: *tpl_group_select_full}
  - {name: '🪙 加密货币', <<: *tpl_group_select_full}
  - {name: '🧲 磁力下载', <<: *tpl_group_select_reject_first}
  - {name: '🛑 广告屏蔽', <<: *tpl_group_select_reject_first}

  # fallback groups
  - {name: '🎯 全球直连', <<: *tpl_group_select_direct_first}
  - {name: '🐟 漏网之鱼', <<: *tpl_group_select_full}

rule-providers:
  custom-proxy:
    <<: *tpl_provider_http_yaml
    path: ./ruleset/custom-proxy.yaml
    url: 'https://raw.githubusercontent.com/SagShang/substore-script/main/CustomProxy.yaml'

rules:
  # 自定义代理
  - 'RULE-SET,custom-proxy,🚀 手动选择'

  # 私有地址
  - 'GEOSITE,private,🎯 全球直连'
  - 'GEOIP,private,🎯 全球直连,no-resolve'

  # 常用
  - 'GEOSITE,category-ads-all,🛑 广告屏蔽'
  - 'GEOSITE,category-ai-!cn,🤖 人工智能'
  - 'GEOSITE,category-public-tracker,🧲 磁力下载'
  - 'GEOSITE,category-pt,🧲 磁力下载'
  - 'GEOSITE,category-cryptocurrency,🪙 加密货币'

  # 游戏平台和游戏下载
  - 'GEOSITE,category-game-platforms-download@cn,🎯 全球直连'
  - 'GEOSITE,category-game-platforms-download,🎮 游戏平台'
  - 'GEOSITE,category-games-cn,🎯 全球直连'
  - 'GEOSITE,category-games-!cn@cn,🎯 全球直连'
  - 'GEOSITE,category-games-!cn,🎮 游戏平台'

  # 流媒体和社交通讯
  - 'GEOSITE,youtube,📹 油管视频'
  - 'GEOSITE,netflix,🎬 奈飞影视'
  - 'GEOIP,netflix,🎬 奈飞影视,no-resolve'
  - 'GEOSITE,disney,🏰 迪士影视'
  - 'GEOSITE,spotify,🎧 声田音乐'
  - 'GEOSITE,bytedance@!cn,🎵 抖音国际'
  - 'GEOSITE,telegram,📲 电报消息'
  - 'GEOIP,telegram,📲 电报消息,no-resolve'
  - 'GEOSITE,x,🐦 推特社交'
  - 'GEOIP,twitter,🐦 推特社交,no-resolve'
  - 'GEOSITE,meta,📘 脸书社交'
  - 'GEOIP,facebook,📘 脸书社交,no-resolve'

  # 大厂服务
  - 'GEOSITE,microsoft@cn,🎯 全球直连'
  - 'GEOSITE,microsoft,Ⓜ️ 微软服务'
  - 'GEOSITE,apple@cn,🎯 全球直连'
  - 'GEOSITE,apple,🍎 苹果服务'
  - 'GEOSITE,google,🌐 谷歌服务'
  - 'GEOIP,google,🌐 谷歌服务,no-resolve'

  # 兜底策略
  - 'GEOSITE,cn,🎯 全球直连'
  - 'GEOIP,CN,🎯 全球直连,no-resolve'
  - 'MATCH,🐟 漏网之鱼'
